<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>衛生紙計算機</title>

    <meta name="description" content="計算最划算的衛生紙，簡單易操作">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.2.4/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.js"></script>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-23385949-5', 'auto');
        ga('send', 'pageview');

    </script>
</head>
<body>

<div class="container" id="app">

    <h1>衛生紙計算機</h1>

    <div class="row">
        <div class="col-md-12">

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>名稱</th>
                        <th>抽</th>
                        <th>包</th>
                        <th>價錢</th>
                        <th>單價/抽</th>
                        <th>備註</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(d, i) in data" is="tissue" :data="d" :index="i+1" :cheapest="isCheapest(d)" @remove="data.splice(i, 1)"></tr>
                </tbody>
            </table>

        </div>
    </div>

    <div class="row">
        <div class="col-md-12 form-inline">

            <div class="input-group">
                <div class="input-group-addon">增加欄位</div>
                <input type="text" v-model="count" class="form-control">
            </div>
            <button type="button" class="btn btn-primary btn-sm" @click="addColumn">
                <i class="fa fa-plus"></i>
            </button>

        </div>
    </div>
</div>

<script type="text/x-template" id="template-tissue">
    <tr :class="{ success: cheapest}">
        <td>{{index}}</td>
        <td><input type="text" class="form-control" v-model="data.name" /></td>
        <td><input type="text" class="form-control" v-model="data.sheet" /></td>
        <td><input type="text" class="form-control" v-model="data.package" /></td>
        <td><input type="text" class="form-control" v-model="data.price" /></td>
        <td><input type="text" class="form-control" v-model="subtotal" readonly /></td>
        <td><input type="text" class="form-control" v-model="data.note" /></td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" @click="$emit('remove')">
                <i class="fa fa-remove"></i>
            </button>
        </td>
    </tr>

</script>

<script>

    Vue.component('tissue', {
        template: '#template-tissue',
        props: ['data', 'index', 'cheapest'],
        computed: {
            subtotal: function() {
                var total = parseFloat(this.data.price) / (parseInt(this.data.sheet) * parseInt(this.data.package));
                return isNaN(total) ? '' : total;
            }
        },
        watch: {
            subtotal: function () {
                this.data.subtotal = this.subtotal;
            }
        }
    });

    var app = new Vue({
        el: '#app',
        data: {
            count: 5,
            data: [
                {
                    name: '',
                    sheet: '',
                    package: '',
                    price: '',
                    subtotal: ''
                }
            ]
        },
        methods: {
            addColumn: function() {
                for(i=0; i<this.count; i++) {
                    this.data.push({
                        name: '',
                        sheet: '',
                        package: '',
                        price: '',
                        subtotal: ''
                    });
                }
            },
            isCheapest: function (data) {
                return data.subtotal == this.cheapest;
            }
        },
        computed: {
            cheapest: function () {
                var arr = $.map(this.data, function(data) {
                    return data.subtotal;
                }).filter(Number);

                return Math.min.apply(null, arr);
            }
        }
    });
</script>

</body>
</html>